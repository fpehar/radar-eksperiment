<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H3c Recall - DHMZ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 20px;
    }

    .card{
      width: 100%;
      max-width: 520px;
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title{
      font-size: 14px;
      font-weight: 600;
      color: #3498db;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .question{
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      line-height: 1.5;
    }

    .inputs{
      display: flex;
      gap: 10px;
      justify-content: space-between;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .digit{
      width: 100%;
      max-width: 90px;
      height: 64px;
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      border: 2px solid #ddd;
      border-radius: 8px;
      outline: none;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .digit:focus{
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
    }

    .hint{
      font-size: 13px;
      color: #7f8c8d;
      font-style: italic;
      padding: 10px;
      background-color: #f8f9fa;
      border-left: 3px solid #95a5a6;
      border-radius: 4px;
    }

    .submit-button{
      padding: 12px 30px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      margin-top: 6px;
    }

    .submit-button:hover{ background-color: #2980b9; }

    .submit-button:disabled{
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .submit-button.success{
      background-color: #27ae60;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="title">Pitanje 3 od 3</div>

    <div class="question">
      Unesite niz brojeva koje ste čuli u uvodnom dijelu ovog zadatka.
    </div>

    <div class="inputs">
      <input class="digit" id="d1" inputmode="numeric" maxlength="1" autocomplete="off" />
      <input class="digit" id="d2" inputmode="numeric" maxlength="1" autocomplete="off" />
      <input class="digit" id="d3" inputmode="numeric" maxlength="1" autocomplete="off" />
      <input class="digit" id="d4" inputmode="numeric" maxlength="1" autocomplete="off" />
    </div>

    <div class="hint">
      Upišite po jedan broj u svako polje.
    </div>

    <button type="button" class="submit-button" id="submitBtn" disabled onclick="submitRecall()">
      Potvrdi unos
    </button>
  </div>

<script>
  const TRIAL_START = Date.now();
  console.log('TRIAL_START_H3c:', TRIAL_START);

  const trialGroupId = localStorage.getItem('trialGroupId') || null;
  console.log('TRIAL_GROUP_ID_H3c:', trialGroupId);

  // očekivani niz (po tvojoj uputi)
  const CORRECT_SEQ = ['7','3','9','5'];

  const inputs = [
    document.getElementById('d1'),
    document.getElementById('d2'),
    document.getElementById('d3'),
    document.getElementById('d4')
  ];

  const submitBtn = document.getElementById('submitBtn');

  function sanitizeDigit(v){
    const m = (v || '').match(/[0-9]/);
    return m ? m[0] : '';
  }

  function updateSubmitState(){
    const allFilled = inputs.every(i => i.value.trim() !== '');
    submitBtn.disabled = !allFilled;
  }

  // auto-advance i filtriranje unosa
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = sanitizeDigit(inp.value);
      updateSubmitState();
      if (inp.value && idx < inputs.length - 1) inputs[idx + 1].focus();
    });

    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !inp.value && idx > 0) inputs[idx - 1].focus();
      if (e.key === 'Enter') {
        if (!submitBtn.disabled) submitBtn.click();
      }
    });
  });

  inputs[0].focus();

  function submitRecall(){
    const seq = inputs.map(i => i.value.trim());
    const responseTime = Date.now() - TRIAL_START;

    submitBtn.disabled = true;
    submitBtn.textContent = "Spremanje...";
    submitBtn.classList.add('success');

    const perDigitCorrect = seq.map((v, i) => v === CORRECT_SEQ[i]);
    const correctCount = perDigitCorrect.filter(Boolean).length;
    const fullyCorrect = (correctCount === CORRECT_SEQ.length);

    const data = {
      trial: 'H3c',
      trialGroupId: trialGroupId,
      recall: {
        entered: seq.join('-'),
        enteredArray: seq,
        correctArray: CORRECT_SEQ,
        perDigitCorrect,
        correctCount,
        fullyCorrect
      },
      totalResponseTime: responseTime,
      timestamp: new Date().toISOString()
    };

    try {
      let allData = [];
      const storedData = localStorage.getItem('experimentData');

      if (storedData) {
        allData = JSON.parse(storedData);
        if (!Array.isArray(allData)) allData = [];
      }

      allData.push(data);
      localStorage.setItem('experimentData', JSON.stringify(allData));
      console.log('Uspješno spremljeno:', data);

    } catch (error) {
      console.error('Greška pri spremanju u localStorage:', error);
      localStorage.setItem('experimentData', JSON.stringify([data]));
    }

    // kraj HIGH bloka -> NASA TLX HIGH
    setTimeout(function(){
      window.location.href = 'nasa_tlx_H.html?trial=H3c';
    }, 400);
  }

  // izloži funkciju za onclick
  window.submitRecall = submitRecall;
</script>
</body>
</html>