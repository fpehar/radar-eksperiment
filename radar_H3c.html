<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>H3c Recall - DHMZ</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body{
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 20px;
    }

    .card{
      width: 100%;
      max-width: 520px;
      background-color: white;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .title{
      font-size: 14px;
      font-weight: 600;
      color: #3498db;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .question{
      font-size: 16px;
      font-weight: 600;
      color: #2c3e50;
      line-height: 1.5;
    }

    .inputs{
      display: flex;
      gap: 10px;
      justify-content: space-between;
      margin-top: 6px;
      margin-bottom: 6px;
    }

    .digit{
      width: 100%;
      max-width: 90px;
      height: 64px;
      text-align: center;
      font-size: 28px;
      font-weight: 700;
      border: 2px solid #ddd;
      border-radius: 8px;
      outline: none;
      background: #fff;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .digit:focus{
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.15);
    }

    .hint{
      font-size: 13px;
      color: #7f8c8d;
      font-style: italic;
      padding: 10px;
      background-color: #f8f9fa;
      border-left: 3px solid #95a5a6;
      border-radius: 4px;
    }

    .submit-button{
      padding: 12px 30px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s;
      width: 100%;
      margin-top: 6px;
    }

    .submit-button:hover{ background-color: #2980b9; }

    .submit-button:disabled{
      background-color: #95a5a6;
      cursor: not-allowed;
    }

    .submit-button.success{
      background-color: #27ae60;
      pointer-events: none;
    }
  </style>
</head>
<body>

  <div class="card">
    <div class="title">Pročitajte i postupite prema uputi (3/3)</div>

    <div class="question">
      Unesite niz brojeva koje ste čuli u uvodnom dijelu ovog zadatka.<br />
      Upišite po jedan broj u svako polje.
    </div>

    <div class="inputs">
      <input type="text" class="digit" id="d1" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="off" />
      <input type="text" class="digit" id="d2" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="off" />
      <input type="text" class="digit" id="d3" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="off" />
      <input type="text" class="digit" id="d4" inputmode="numeric" pattern="[0-9]*" maxlength="1" autocomplete="off" />
    </div>

    <button type="button" class="submit-button" id="submitBtn" disabled>
      Potvrdi unos
    </button>
  </div>


<script>
  const TRIAL_START = Date.now();
  console.log('TRIAL_START_H3c:', TRIAL_START);

  // ✅ DOHVATI SVE ID-EVE
  const participantId = localStorage.getItem('participantId') || null;
  const participantCode = localStorage.getItem('participantCode') || null;
  const startBlock = localStorage.getItem('startBlock') || null;
  let trialGroupId = localStorage.getItem('trialGroupId') || null;

  if (!trialGroupId) {
    // fallback: ako je netko otvorio H3c direktno
    const rand = Math.random().toString(16).slice(2);
    trialGroupId = `TG_${Date.now()}_${rand}`;
    localStorage.setItem('trialGroupId', trialGroupId);
  }

  console.log('TRIAL_GROUP_ID_H3c:', trialGroupId);
  console.log('PARTICIPANT_ID_H3c:', participantId);

  // ✅ očekivani niz
  const CORRECT_SEQ = ['7','3','9','5'];

  const inputs = [
    document.getElementById('d1'),
    document.getElementById('d2'),
    document.getElementById('d3'),
    document.getElementById('d4')
  ];

  const submitBtn = document.getElementById('submitBtn');

  // Guard da se submit ne okine dvaput
  let alreadySubmitted = false;

  // Klik na gumb
  submitBtn.addEventListener('click', submitRecall);

  // Pouzdano osvježavanje stanja gumba
  inputs.forEach((inp) => {
    inp.addEventListener('input', updateSubmitState);
    inp.addEventListener('change', updateSubmitState);
    inp.addEventListener('keyup', updateSubmitState);
  });

  function sanitizeDigit(v){
    const m = (v || '').match(/[0-9]/);
    return m ? m[0] : '';
  }

  function updateSubmitState(){
    const allFilled = inputs.every(i => i.value.trim() !== '');
    submitBtn.disabled = !allFilled || alreadySubmitted;
  }

  // Standardno spremanje (append u experimentData)
  function appendExperimentData(entry) {
    try {
      let allData = [];
      const stored = localStorage.getItem('experimentData');
      if (stored) {
        allData = JSON.parse(stored);
        if (!Array.isArray(allData)) allData = [];
      }
      allData.push(entry);
      localStorage.setItem('experimentData', JSON.stringify(allData));
    } catch (e) {
      console.error('Greška pri spremanju u localStorage:', e);
      localStorage.setItem('experimentData', JSON.stringify([entry]));
    }
  }

  // bilježi vrijeme prvog unosa
  let firstInputTime = null;

  // auto-advance i filtriranje unosa
  inputs.forEach((inp, idx) => {
    inp.addEventListener('input', () => {
      inp.value = sanitizeDigit(inp.value);

      if (inp.value && firstInputTime === null) {
        firstInputTime = Date.now();
        console.log('FIRST_INPUT_H3c:', firstInputTime - TRIAL_START);
      }

      updateSubmitState();

      if (inp.value && idx < inputs.length - 1) {
        inputs[idx + 1].focus();
      }
    });

    inp.addEventListener('keydown', (e) => {
      if (e.key === 'Backspace' && !inp.value && idx > 0) {
        inputs[idx - 1].focus();
      }

      // Enter = potvrdi, ali spriječi "implicitni submit"/refresh
      if (e.key === 'Enter') {
        e.preventDefault();
        if (!submitBtn.disabled) submitBtn.click();
      }
    });
  });

  // dodatna zaštita: Enter bilo gdje na stranici ne smije napraviti refresh
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
    }
  });

  // fokus na prvo polje
  inputs[0].focus();
  updateSubmitState();

  function submitRecall(){
    if (alreadySubmitted) return;

    const allFilled = inputs.every(i => i.value.trim() !== '');
    if (!allFilled) return;

    alreadySubmitted = true;
    updateSubmitState();

    const seq = inputs.map(i => i.value.trim());
    const responseTime = Date.now() - TRIAL_START;

    submitBtn.disabled = true;
    submitBtn.textContent = "Spremanje...";
    submitBtn.classList.add('success');

    // zaključaj polja da se ništa ne okida ponovno
    inputs.forEach(i => i.disabled = true);

    // točnost: full match + broj pogodaka
    const perDigitCorrect = seq.map((v, i) => v === CORRECT_SEQ[i]);
    const correctCount = perDigitCorrect.filter(Boolean).length;
    const fullyCorrect = (correctCount === CORRECT_SEQ.length);

    // ✅ KOMPLETAN DATA OBJECT
    const data = {
      // Identifikatori
      participantId: participantId,
      participantCode: participantCode,
      trialGroupId: trialGroupId,
      startBlock: startBlock,
      
      // Trial info
      trial: 'H3c',
      trialType: 'HIGH',
      taskDescription: 'Dual-task digit recall',
      
      // Recall data
      recall: {
        entered: seq.join('-'),
        enteredArray: seq,
        correctArray: CORRECT_SEQ,
        perDigitCorrect: perDigitCorrect,
        correctCount: correctCount,
        fullyCorrect: fullyCorrect,
        firstInputTime: firstInputTime ? (firstInputTime - TRIAL_START) : null
      },
      
      // Timing
      totalResponseTime: responseTime,
      timestamp: new Date().toISOString(),

      // ✅ ET SYNC (Unix timestamps)
      unixTimestamps: {
        trialStart: TRIAL_START,
        firstInput: firstInputTime ? firstInputTime : null,
        submit: Date.now()
      }
    };

    appendExperimentData(data);
    console.log('Uspješno spremljeno (H3c):', data);

    // replace() je bolji (manje problema s Back i "loop" ponašanjem)
    window.location.replace('nasa_tlx_H.html?trial=H3c');
  }

  window.submitRecall = submitRecall;
</script>

</body>
</html>